import"../../CommonImports";import"../../Core/core.css";import"./Table.css";import*as React from"react";import{ListDropIndicatorPosition}from"../../Components/List/ListDropIndicator.Props";import{cellFromEvent}from"../../List";import{getPointByEventType}from"../../Util";import{beginDragOperation,DragDropEffect,DragImage}from"../../Utilities/DragDrop";import{beginDragOperationOptimized,DragImageOptimized}from"../../Utilities/DragDropInternal";import{ListDropIndicator}from"../List/ListDropIndicator";import{ColumnFillId}from"./Table";var DragAndDropOptimizationsBodyClassName="dnd-behaviors-optimizations-enabled",ColumnDragDropBehavior=function(){function t(t){var r=this;this.initialize=function(t,e,n){r.dragDroppableUI=e,r.eventDispatch=n,r.eventDispatch.addEventListener("pointerdown",r.onPointerDown),r.eventDispatch.addEventListener("dragstart",r.onDragStart),r.eventDispatch.addEventListener("dragend",r.onDragEnd),r.eventDispatch.addEventListener("dragenter",r.onDragEnter),r.eventDispatch.addEventListener("dragexit",r.onDragExit),r.eventDispatch.addEventListener("dragover",r.onDragOver),r.eventDispatch.addEventListener("drop",r.onDrop),r.indicatorName="drop-indicator"},this.onDragEnd=function(t){var e=eventIsOnHeader(t);e&&0<=e&&r.options.onDragEnd&&r.options.onDragEnd(t),r.dragDroppableUI.removeOverlay("drag-source-item"),r.dragImageData=void 0},this.onDragStart=function(t){var e;t.detail.dataTransfer&&!t.defaultPrevented&&null!==(e=eventIsOnHeader(t))&&0<=e&&(r.options.onDragStart&&r.options.onDragStart(t),t.detail.dataTransfer.effectAllowed!==DragDropEffect.none)&&(r.dragDroppableUI.addOverlay("drag-source-item",-1,r.renderDragSourceItemOverlay,0,e),void 0===r.dragImageData)&&(r.dragImageData={image:r.options.renderDragImage(t)})},this.onPointerDown=function(t){0===t.button&&r.beginDrag(t)},this.renderDragSourceItemOverlay=function(t){return document.body.classList.contains(DragAndDropOptimizationsBodyClassName)?React.createElement(React.Fragment,null,React.createElement("div",{className:"bolt-list-drag-source-item flex-grow"}),r.operationOptimized&&r.dragImageData&&React.createElement(DragImageOptimized,{operation:r.operationOptimized},r.dragImageData.image)):React.createElement(React.Fragment,null,React.createElement("div",{className:"bolt-list-drag-source-item flex-grow"}),r.operation&&r.dragImageData&&React.createElement(DragImage,{operation:r.operation},r.dragImageData.image))},this.setDragImage=function(t,e,n){r.dragImageData={image:t,xOffset:e,yOffset:n}},this.onDragEnter=function(t){r.handlesType(t)&&(r.options.onDragEnter?r.options.onDragEnter(t):t.detail.dataTransfer.dropEffect=DragDropEffect.move)},this.onDragExit=function(t){r.handlesType(t)&&(r.options.onDragExit&&r.options.onDragExit(t),r.dragDroppableUI.removeOverlay(r.indicatorName))},this.onDragOver=function(t){var e,n,a;r.handlesType(t)&&(e=r.calculateIndex(t),n=t.detail.dataTransfer.secondaryData.index,a=t.detail.dataTransfer.secondaryData.sourceId,0<=e&&(e!==n||a!==r.options.id)&&r.options.columns[e].id!==ColumnFillId?r.options.onDragOver?r.options.onDragOver(t,{index:r.listIndicatorPosition===ListDropIndicatorPosition.right?e+1:e}):t.detail.dataTransfer.dropEffect=DragDropEffect.move:t.detail.dataTransfer.dropEffect=DragDropEffect.none,t.detail.dataTransfer.dropEffect===DragDropEffect.none?r.dragDroppableUI.removeOverlay(r.indicatorName):r.dragDroppableUI.addOverlay(r.indicatorName,-1,r.renderDropIndicator,0,e))},this.onDrop=function(t){var e,n,a;r.handlesType(t)&&(e=r.calculateIndex(t),n=t.detail.dataTransfer.secondaryData.index,a=t.detail.dataTransfer.secondaryData.sourceId,0<=e&&(e!==n||a!==r.options.id)&&r.options.onDrop&&(t.persist(),r.options.onDrop(t,{index:r.listIndicatorPosition===ListDropIndicatorPosition.right?e+1:e})),r.dragDroppableUI.removeOverlay(r.indicatorName))},this.renderDropIndicator=function(t){t=r.listIndicatorPosition===ListDropIndicatorPosition.right?t.rowElement.offsetWidth:0;return React.createElement(ListDropIndicator,{position:r.listIndicatorPosition,xOffset:t-3,lineOffset:t})},this.options=t,this.contextMenuIndex=t.columns.findIndex(function(t){return"_more"===t.id})}return t.prototype.componentWillUnmount=function(){var t;null!=(t=this.eventDispatch)&&t.removeEventListener("pointerdown",this.onPointerDown),null!=(t=this.eventDispatch)&&t.removeEventListener("dragstart",this.onDragStart),null!=(t=this.eventDispatch)&&t.removeEventListener("dragend",this.onDragEnd),null!=(t=this.eventDispatch)&&t.removeEventListener("dragenter",this.onDragEnter),null!=(t=this.eventDispatch)&&t.removeEventListener("dragexit",this.onDragExit),null!=(t=this.eventDispatch)&&t.removeEventListener("dragover",this.onDragOver),null!=(t=this.eventDispatch)&&t.removeEventListener("drop",this.onDrop)},t.prototype.updateBehaviorOptions=function(t){this.options=t},t.prototype.beginDrag=function(t){var e,n=eventIsOnHeader(t);null!==n&&null!=(e=this.options)&&e.columns&&0<=n&&(e=this.options.columns[n],document.body.classList.contains(DragAndDropOptimizationsBodyClassName)?this.operationOptimized=beginDragOperationOptimized(t,{data:e,dropEffect:DragDropEffect.none,secondaryData:{index:n,sourceId:this.options.id},setDragImage:this.setDragImage,type:this.options.type}):this.operation=beginDragOperation(t,{data:e,dropEffect:DragDropEffect.none,secondaryData:{index:n,sourceId:this.options.id},setDragImage:this.setDragImage,type:this.options.type}))},t.prototype.handlesType=function(t){t=(null==(t=t.detail.dataTransfer)?void 0:t.type)||"";return-1!==this.options.allowedTypes.indexOf(t)},t.prototype.calculateIndex=function(t){var e,n=cellFromEvent(t),a=n.cellIndex;return n.cellElement&&t.detail.dataTransfer.secondaryData&&(e=t.detail.dataTransfer.secondaryData.index,t=t.detail.nativeEvent,n=n.cellElement.getBoundingClientRect(),t=(t=getPointByEventType(t))?t.x<n.width/2+n.left:a<e,a<e?(this.listIndicatorPosition=ListDropIndicatorPosition.left,t||a++,a===this.contextMenuIndex&&a--):e<a&&(this.listIndicatorPosition=ListDropIndicatorPosition.right,t&&a--,a+1<this.options.columns.length)&&a+1==this.contextMenuIndex&&a++),a},t}();function eventIsOnHeader(t){t=cellFromEvent(t);return-1===t.rowIndex?t.cellIndex:null}export{ColumnDragDropBehavior};